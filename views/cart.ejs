<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />

    <title>Meehh - Shopping Cart</title>

    <!-- Fav Icon -->
    <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- Stylesheets -->
    <link href="/assets/css/font-awesome-all.css" rel="stylesheet" />
    <link href="/assets/css/flaticon.css" rel="stylesheet" />
    <link href="/assets/css/owl.css" rel="stylesheet" />
    <link href="/assets/css/bootstrap.css" rel="stylesheet" />
    <link href="/assets/css/jquery.fancybox.min.css" rel="stylesheet" />
    <link href="/assets/css/animate.css" rel="stylesheet" />
    <link href="/assets/css/jquery-ui.css" rel="stylesheet" />
    <link href="/assets/css/jquery.bootstrap-touchspin.css" rel="stylesheet" />
    <link href="/assets/css/nice-select.css" rel="stylesheet" />
    <link href="/assets/css/color.css" rel="stylesheet" />
    <link href="/assets/css/style.css" rel="stylesheet" />
    <link href="/assets/css/responsive.css" rel="stylesheet" />

    <script src="https://checkout.razorpay.com/v1/checkout.js" async defer></script>
  </head>

  <!-- page wrapper -->
  <body>
    <div class="boxed_wrapper">
      <!-- search-popup -->
      <div id="search-popup" class="search-popup">
        <div class="close-search"><i class="flaticon-close"></i></div>
        <div class="popup-inner">
          <div class="overlay-layer"></div>
          <div class="search-form">
            <form method="post" action="/">
              <div class="form-group">
                <fieldset>
                  <input
                    type="search"
                    class="form-control"
                    name="search-input"
                    value=""
                    placeholder="Search Here"
                    required
                  />
                  <input
                    type="submit"
                    value="Search Now!"
                    class="theme-btn style-four"
                  />
                </fieldset>
              </div>
            </form>
            <h3>Recent Search Keywords</h3>
            <ul class="recent-searches">
              <li><a href="/">Finance</a></li>
              <li><a href="/">Idea</a></li>
              <li><a href="/">Service</a></li>
              <li><a href="/">Growth</a></li>
              <li><a href="/">Plan</a></li>
            </ul>
          </div>
        </div>
      </div>
      <!-- search-popup end -->

      <!-- main header -->
      <header class="main-header">
        <div class="header-lower">
          <div class="auto-container">
            <div class="outer-box">
              <figure class="logo-box">
                <a href="/"
                  ><img src="assets/images/header-logo.png" alt=""
                /></a>
              </figure>
              <div class="menu-area">
                <!--Mobile Navigation Toggler-->
                <div class="mobile-nav-toggler">
                  <i class="icon-bar"></i>
                  <i class="icon-bar"></i>
                  <i class="icon-bar"></i>
                </div>
                <nav class="main-menu navbar-expand-md navbar-light">
                  <div
                    class="collapse navbar-collapse show clearfix"
                    id="navbarSupportedContent"
                  >
                    <ul class="navigation clearfix">
                      <li class="current">
                        <a href="/">Home</a>
                      </li>

                      <li class="dropdown">
                        <a href="/products">Shop<span>Hot</span></a>
                        <div class="megamenu">
                          <div class="row clearfix">
                            <div class="col-lg-4 column">
                              <ul>
                                <li><h4>Category 01</h4></li>
                                <li><a href="/">Sub-category 01</a></li>
                                <li><a href="/">Sub-category 02</a></li>
                                <li><a href="/">Sub-category 03</a></li>
                                <li><a href="/">Sub-category 04</a></li>
                                <li><a href="/">Sub-category 05</a></li>
                                <li><a href="/">Sub-category 06</a></li>
                              </ul>
                            </div>
                            <div class="col-lg-4 column">
                              <ul>
                                <li><h4>Category 02 Page</h4></li>
                                <li><a href="/">Sub-category 01</a></li>
                                <li><a href="/">Sub-category 02</a></li>
                                <li><a href="/">Sub-category 03</a></li>
                                <li><a href="/">Sub-category 04</a></li>
                                <li><a href="/">Sub-category 05</a></li>
                                <li><a href="/">Sub-category 06</a></li>
                                <li><a href="/">Sub-category 07</a></li>
                              </ul>
                            </div>
                            <div class="col-lg-4 column">
                              <ul>
                                <li><h4>Category 03</h4></li>
                                <li><a href="/">Sub-category 01</a></li>
                                <li><a href="/">Sub-category 02</a></li>
                                <li><a href="/">Sub-category 03</a></li>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </li>
                      <li><a href="/about">About</a></li>
                      <li class="dropdown">
                        <a href="/blogs">Blog</a>
                        <ul>
                          <li><a href="blog.html">Blog 01</a></li>
                          <li><a href="blog-2.html">Blog 02</a></li>
                          <li><a href="blog-3.html">Blog 03</a></li>
                          <li><a href="blog-4.html">Blog 04</a></li>
                          <li><a href="blog-5.html">Blog 05</a></li>
                          <li>
                            <a href="blog-details.html">Blog Details 01</a>
                          </li>
                          <li>
                            <a href="blog-details-2.html">Blog Details 02</a>
                          </li>
                        </ul>
                      </li>
                      <li><a href="/contact">Contact</a></li>
                    </ul>
                  </div>
                </nav>
              </div>
              <ul class="menu-right-content clearfix">
                <li>
                  <div class="search-btn">
                    <button type="button" class="search-toggler">
                      <i class="flaticon-search"></i>
                    </button>
                  </div>
                </li>
                <li>
                  <a href="/wishlist"><i class="flaticon-like"></i></a>
                </li>
                <li class="dropdown">
                  <a href=""><i class="flaticon-user"></i></a>
                  <ul>
                    <% if(userLoggedIn) { %>
                    <li><a href="/profile">Profile</a></li>
                    <li><a href="/orders">Your orders</a></li>
                    <li><a href="/logout">Logout</a></li>
                    <% } else { %>
                    <li><a href="/login">Log In</a></li>
                    <li><a href="/register">Sign Up</a></li>
                    <% } %>
                  </ul>
                </li>
                <li class="shop-cart">
                  <a href="/cart"
                    ><i class="flaticon-shopping-cart-1"></i
                    ><span><%=cart.length%></span></a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!--sticky Header-->
        <div class="sticky-header">
          <div class="auto-container">
            <div class="outer-box clearfix">
              <div class="logo-box pull-left">
                <figure class="logo">
                  <a href="/"
                    ><img src="assets/images/small-logo.png" alt=""
                  /></a>
                </figure>
              </div>
              <div class="menu-area pull-right">
                <nav class="main-menu clearfix">
                  <!--Keep This Empty / Menu will come through Javascript-->
                </nav>
              </div>
            </div>
          </div>
        </div>
      </header>
      <!-- main-header end -->

      <!-- Mobile Menu  -->
      <div class="mobile-menu">
        <div class="menu-backdrop"></div>
        <div class="close-btn"><i class="fas fa-times"></i></div>
        <nav class="menu-box">
          <div class="nav-logo">
            <a href="/"
              ><img src="assets/images/logo-2.png" alt="" title=""
            /></a>
          </div>
          <div class="menu-outer">
            <!--Here Menu Will Come Automatically Via Javascript / Same Menu as in Header-->
          </div>
          <div class="contact-info">
            <h4>Contact Info</h4>
            <ul>
              <li>Chicago 12, Melborne City, USA</li>
              <li><a href="tel:+8801682648101">+88 01682648101</a></li>
              <li><a href="mailto:info@example.com">info@example.com</a></li>
            </ul>
          </div>
          <div class="social-links">
            <ul class="clearfix">
              <li>
                <a href="/"><span class="fab fa-twitter"></span></a>
              </li>
              <li>
                <a href="/"
                  ><span class="fab fa-facebook-square"></span
                ></a>
              </li>
              <li>
                <a href="/"
                  ><span class="fab fa-pinterest-p"></span
                ></a>
              </li>
              <li>
                <a href="/"><span class="fab fa-instagram"></span></a>
              </li>
              <li>
                <a href="/"><span class="fab fa-youtube"></span></a>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <!-- End Mobile Menu -->

      <!-- cart section -->

      <% if (cart != null && cart.length > 0) { %>
      <!-- page-title -->
      <section class="page-title centred">
        <div
          class="pattern-layer"
          style="
            background-image: url(/assets/images/background/page-title.jpg);
          "
        ></div>
        <div class="auto-container">
          <div class="content-box">
            <h1>Cart</h1>
            <ul class="bread-crumb clearfix">
              <li><i class="flaticon-home-1"></i><a href="/">Home</a></li>
              <li>Cart</li>
            </ul>
          </div>
        </div>
      </section>
      <!-- page-title end -->

      <!-- Multistep form -->
      <div class="container">
        <div class="row justify-content-center mt-0">
          <div class="col-12 text-center p-0 mt-3 mb-2">
            <div class="px-0 pt-4 pb-0 mt-3 mb-3">
              <div class="mx-0">
                <div id="msform">
                  <!-- progressbar -->
                  <ul id="progressbar">
                    <li class="active" id="cart">
                      <i class="flaticon-shopping-cart-1"></i>
                      Cart
                    </li>
                    <li id="shipping">
                      <i class="flaticon-location-pin-1"></i>
                      Shipping
                    </li>
                    <li id="payment"><i class="far fa-payment"></i>Payment
                    </li>
                  </ul>
                  <!-- fieldsets -->
                  <fieldset class="cart-section steps">
                    <div class="row clearfix">
                      <div
                        class="col-lg-12 col-md-12 col-sm-12 table-column mb-4"
                      >
                        <div class="table-outer">
                          <table class="cart-table">
                            <thead class="cart-header">
                              <tr>
                                <th>&nbsp;</th>
                                <th class="prod-column">Product Name</th>
                                <th>&nbsp;</th>
                                <th>&nbsp;</th>
                                <th class="price">Price</th>
                                <th class="quantity">Quantity</th>
                                <th>Subtotal</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% for(let i=0; i<cart.length; i++) { %>
                              <tr>
                                <td colspan="4" class="prod-column">
                                  <div class="column-box">
                                    <div
                                      class="remove-btn"
                                      onClick="deleteFromCart('<%= cart[i]._id %>', this)"
                                    >
                                      <i class="flaticon-close"></i>
                                    </div>
                                    <div class="prod-thumb">
                                      <a href="#"
                                        ><img
                                          src="<%= cart[i].product_id.inventory[0].thumbnail_images[0]?cart[i].product_id.inventory[0].thumbnail_images[0]:'/assets/images/resource/shop/cart-1.jpg'%>"
                                          alt="Product Image"
                                      /></a>
                                    </div>
                                    <div class="prod-title">
                                      <%= cart[i].product_id.product_name%>
                                    </div>
                                    <div><%= cart[i].selected_size%></div>
                                    <div><%= cart[i].selected_color%></div>
                                  </div>
                                </td>
                                <td class="price">
                                  &#x20B9;<%= cart[i].product_id.price %>
                                </td>
                                <td class="qty">
                                  <div class="item-quantity">
                                    <input
                                      value="<%=cart[i].quantity%>"
                                      id="<%=cart[i]._id%>%>"
                                      class="quantity-spinner"
                                      type="text"
                                      name="quantity"
                                    />
                                  </div>
                                </td>
                                <td class="sub-total">
                                  &#x20B9;<%= cart[i].quantity *
                                  cart[i].product_id.price %>
                                </td>
                              </tr>
                              <% } %>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                    <div class="cart-total">
                      <div class="row">
                        <div class="col-12 col-md-5 offset-md-7 cart-column">
                          <div class="total-cart-box clearfix">
                            <h4>Cart Totals</h4>
                            <ul class="list clearfix">
                              <li>
                                Subtotal:<span class="sub-total"></span>
                              </li>
                              <li>
                                Shipping:<span class="shipping-charge">&#x20B9; 80</span>
                              </li>
                              <li>
                                Order Total:<span class="order-total" ></span>
                              </li>
                            </ul>
                            
                          </div>
                        </div>
                      </div>
                    </div>
                    <button name="next" class="next theme-btn-two">
                      Proceed
                      <i class="flaticon-right-1"></i>
                    </button>
                  </fieldset>
                  <fieldset class="checkout-section steps">
                    <div class="shipping-info">
                      <h4 class="sub-title">Shipping Details</h4>
                      
                      <% if(addresses.length > 0) { %>
                        <div class="card-columns my-5 addresses">
                          <% for(let i=0;i<addresses.length;i++) { %>
                          <div class="option-block card p-4">
                            <div class="custom-controls-stacked">
                              <label class="custom-control material-checkbox">
                                <input
                                  type="checkbox"
                                  class="material-control-input"
                                  onchange="selectAddress(<%=i%>)"
                                />
                                <span class="material-control-indicator"></span>
                                <h5 class="description"><%= addresses[i].first_name %> <%= addresses[i].last_name %></h5>
                                <p>
                                  <%= addresses[i].house_no %>, <%= addresses[i].street %>, <%= addresses[i].landmark %> <%= addresses[i].landmark && "," %> <%= addresses[i].city %> - <%= addresses[i].pincode %>
                                  <br> 
                                  <%= addresses[i].state %>
                                </p>
                              </label>
                            </div>
                          </div>
                          <% } %>
                        <% } %>
                          <div class="card add-new-address" onclick="showAddressFields()">
                            <div class="card-body">
                              <div class="flaticon-plus"></div>
                              <div class="card-title">Add new address</div>
                            </div>
                          </div>
                        </div>

                      <form action="/profile/add-new-address" method="post" class="shipping-form d-none">
                        <h4 class="details-title ml-3">Personal Details</h4>
                        <div class="row">
                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>First Name*</label>
                            <div class="field-input">
                              <input type="text" required name="first_name" />
                            </div>
                          </div>
                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>Last Name*</label>
                            <div class="field-input">
                              <input type="text" required name="last_name" />
                            </div>
                          </div>
                        </div>
                        <h4 class="details-title ml-3">Address Details</h4>
                        <div class="row">  
                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>House No.*</label>
                            <div class="field-input">
                              <input type="text" required name="house_no" />
                            </div>
                          </div>
                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>Street*</label>
                            <div class="field-input">
                              <input type="text" required name="street" />
                            </div>
                          </div>
                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>Landmark <span>(optional)</span></label>
                            <div class="field-input">
                              <input type="text" name="landmark" />
                            </div>
                          </div>
                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>City*</label>
                            <div class="field-input">
                              <input type="text" required name="city" />
                            </div>
                          </div>
                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>State*</label>
                            <div class="field-input">
                              <input type="text" required name="state" />
                            </div>
                          </div>

                          <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                            <label>Pin Code*</label>
                            <div class="field-input">
                              <input type="text" required name="pincode" />
                            </div>
                          </div>
                        </div>
                        <input type="submit" value="Save" class="theme-btn-two ml-3">
                      </form>
                    </div>
                    <button class="previous theme-btn-three">
                      <i class="flaticon-left-2"></i>
                      Go Back
                    </button>
                    <button class="next theme-btn-two shipping-section">
                      Proceed
                      <i class="flaticon-right-1"></i>
                    </button>
                  </fieldset>
                  
                  <fieldset class="steps">
                    <div class="order-summary border rounded p-3 col-md-8 mb-4 mx-auto">
                      <h3 class="pb-3 mb-2 border-bottom">Order Summary</h3>
                      <div class="order-items">
                        <% for(let i=0; i<cart.length; i++) { %>
                          <div class="item">
                            <div class="d-flex align-items-center">
                              <img
                              src="<%= cart[i].product_id.inventory[0].thumbnail_images[0] || '/assets/images/resource/shop/cart-1.jpg'%>"
                              alt="Product Image"
                              />
                              <div class="text-left">
                                <div class="product-name text-dark"><%= cart[i].product_id.product_name%></div>
                                <div class="product-specs text-muted"><%= cart[i].selected_size%> <%= cart[i].selected_color%></div>
                              </div>
                            </div>
                            <div class="quantity ">&times;<%=cart[i].quantity%></div>
                            <div class="total_amt ">Rs. <%= cart[i].quantity * cart[i].product_id.price %></div>
                          </div>
                          <% } %>
                      </div>
                      <div class="order-total mt-3 text-right">
                        <div class="sub-total">Sub Total: <span></span></div>
                        <!-- <div class="coupon-discount text-primary">- Coupon Discount: <span></span></div> -->
                        <div class="">+ Shipping: <span>Rs. 80</span></div>
                        <div class="grand-total text-dark">Grand Total: <span></span></div>
                      </div>
                      <div class="shipping-summary">
                        <h5>Shipping Details</h5>
                        <div class="name"></div>
                        <div class="address"></div>
                      </div>
                      <button class="theme-btn-two my-4" id="checkout">Pay now</button>
                    </div>
                    <button class="previous theme-btn-one">
                      <i class="flaticon-left-2"></i>
                      Go Back
                    </button>
                  </fieldset>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- page-title end -->

      <% } else { %>
      <div class="empty-cart container">
        <img
          src="\assets\images\icons\empty_cart.svg"
          alt="Empty Cart Icon"
          class="icon"
        />
        <div class="text">
          Your shopping cart is empty <i class="far fa-sad-tear"></i>
        </div>
        <div class="theme-btn-three">
          <a href="/products"
            >Continue Shopping<i class="flaticon-right-1"></i
          ></a>
        </div>
      </div>
      <% } %>

      <!-- cart section end -->

      <%- include('footer')%>
    </div>
    <!-- jequery plugins -->
    <script src="/assets/js/jquery.js"></script>
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/owl.js"></script>
    <script src="/assets/js/wow.js"></script>
    <script src="/assets/js/validation.js"></script>
    <script src="/assets/js/jquery.fancybox.js"></script>
    <script src="/assets/js/TweenMax.min.js"></script>
    <script src="/assets/js/appear.js"></script>
    <script src="/assets/js/scrollbar.js"></script>
    <script src="/assets/js/jquery.nice-select.min.js"></script>
    <script src="/assets/js/isotope.js"></script>
    <script src="/assets/js/jquery-ui.js"></script>
    <script src="/assets/js/jquery.bootstrap-touchspin.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css"></script>

    <!-- main-js -->
    <script src="/assets/js/script.js"></script>
    <script src="/assets/js/cart.js"></script>
    
    <script>
      var clientCart = <%- JSON.stringify(cart) %>
      var addresses = <%- JSON.stringify(addresses) %>

      const subTotals = clientCart.map((item) => {
        return item.quantity * item.product_id.price;
      });
      const grandTotal = [...subTotals, 80]

      const subTotalSpan = document.querySelector(
        ".total-cart-box ul.list li span.sub-total"
      );
      const orderTotalSpan = document.querySelector(
        ".total-cart-box ul.list li span.order-total"
      );
      subTotalSpan.innerHTML = `&#x20B9; ${subTotals.reduce((total, num) => {
        return num + total;
      }, 0)}`;
      orderTotalSpan.innerHTML = `&#x20B9; ${grandTotal.reduce((total, num) => {
        return num + total;
      }, 0)}`;

      const plusButtons = document.querySelectorAll(".bootstrap-touchspin-up");
      const minusButtons = document.querySelectorAll(
        ".bootstrap-touchspin-down"
      );

      for (let i = 0; i < plusButtons.length; i++) {
        plusButtons[i].onclick = () => {
          const itemId =
            plusButtons[i].parentElement.parentElement.childNodes[1].id;
          updateCart(itemId, 1);
        };
      }

      for (let i = 0; i < minusButtons.length; i++) {
        minusButtons[i].onclick = () => {
          const itemId =
            minusButtons[i].parentElement.parentElement.childNodes[1].id;
          updateCart(itemId, -1);
        };
      }

      async function deleteFromCart(id, e) {
        const data = { id };
        const url = "/cart/deleteFromCart";
        const options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            // 'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: JSON.stringify(data),
        };
        const res = await fetch(url, options);
        if (!res.ok)
          alert(
            "An error occurred while updating your cart. Please try again later!"
          );
        else location.reload(false);
      }

      async function updateCart(id, quantity) {
        console.log(id);
        const data = { id, quantity };
        const url = "/cart/updateCart";
        const options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        };
        const res = await fetch(url, options);
        console.log(res);
        if (!res.ok) {
          alert(
            "An error occurred while updating your cart. Please try again later!"
          );
          quantity > 0
            ? document.getElementById(id).value--
            : document.getElementById(id).value++;
        } else {
          console.log(res);
          location.reload(false);
        }
      }

      // Multi-step code
$(document).ready(function () {
  var current_fs, next_fs, previous_fs; //fieldsets
  var opacity;

  $(".next").click(function () {
    current_fs = $(this).parent();
    next_fs = $(this).parent().next();

    if (this.classList.contains("shipping-section")) {
      createOrder();
    }

    //Add Class Active
    $("#progressbar li")
      .eq($("fieldset.steps").index(next_fs))
      .addClass("active");

    //show the next fieldset
    next_fs.show();
    //hide the current fieldset with style
    current_fs.animate(
      { opacity: 0 },
      {
        step: function (now) {
          // for making fielset appear animation
          opacity = 1 - now;

          current_fs.css({
            display: "none",
            position: "relative",
          });
          next_fs.css({ opacity: opacity });
        },
        duration: 600,
      }
    );
  });

  $(".previous").click(function () {
    current_fs = $(this).parent();
    previous_fs = $(this).parent().prev();

    //Remove class active
    $("#progressbar li")
      .eq($("fieldset").index(current_fs))
      .removeClass("active");

    //show the previous fieldset
    previous_fs.show();

    //hide the current fieldset with style
    current_fs.animate(
      { opacity: 0 },
      {
        step: function (now) {
          // for making fielset appear animation
          opacity = 1 - now;

          current_fs.css({
            display: "none",
            position: "relative",
          });
          previous_fs.css({ opacity: opacity });
        },
        duration: 600,
      }
    );
  });

  $(".radio-group .radio").click(function () {
    $(this).parent().find(".radio").removeClass("selected");
    $(this).addClass("selected");
  });

  $(".submit").click(function () {
    return false;
  });
});
      
    </script>
  </body>
</html>
