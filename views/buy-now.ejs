<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />

    <title>Meehh.com - Shopping Cart</title>

    <!-- Fav Icon -->
    <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- Stylesheets -->
    <link href="/assets/css/font-awesome-all.css" rel="stylesheet" />
    <link href="/assets/css/flaticon.css" rel="stylesheet" />
    <link href="/assets/css/owl.css" rel="stylesheet" />
    <link href="/assets/css/bootstrap.css" rel="stylesheet" />
    <link href="/assets/css/jquery.fancybox.min.css" rel="stylesheet" />
    <link href="/assets/css/animate.css" rel="stylesheet" />
    <link href="/assets/css/jquery-ui.css" rel="stylesheet" />
    <link href="/assets/css/jquery.bootstrap-touchspin.css" rel="stylesheet" />
    <link href="/assets/css/nice-select.css" rel="stylesheet" />
    <link href="/assets/css/color.css" rel="stylesheet" />
    <link href="/assets/css/style.css" rel="stylesheet" />
    <link href="/assets/css/responsive.css" rel="stylesheet" />

    <script src="https://checkout.razorpay.com/v1/checkout.js" async defer></script>
  </head>

  <!-- page wrapper -->
  <body>
    <div class="boxed_wrapper">
      <!-- search-popup -->
          <div id="search-popup" class="search-popup">
              <div class="close-search"><i class="flaticon-close"></i></div>
              <div class="popup-inner">
                  <div class="overlay-layer"></div>
                  <div class="search-form">
                      <form method="GET" action="/products/search">
                          <div class="form-group">
                              <fieldset>
                                  <input type="search" class="form-control" name="q" value="" placeholder="Search Here" required >
                                  <input type="submit" value="Search Now!" class="theme-btn style-four">
                              </fieldset>
                          </div>
                      </form>
                      <h3>Popular Search Keywords</h3>
                      <ul class="recent-searches">
                          <li><a href="/products?category=bookmark">Bookmark</a></li>
                          <li><a href="/products?category=pop gripper">Pop Grippers</a></li>
                          <li><a href="/products/search?q=friends">Friends</a></li>
                          <li><a href="/products/search?q">Game of Thrones</a></li>
                          <li><a href="/products/search?q=blackpink">Blackpink</a></li>
                      </ul>
                  </div>
              </div>
          </div>
          <!-- search-popup end -->


          <!-- main header -->
          <header class="main-header">
              
              <div class="header-lower">
                  <div class="auto-container">
                      <div class="outer-box">
                          <figure class="logo-box"><a href="/"><img src="/assets/images/header-logo.png" alt=""></a></figure>
                          <div class="menu-area">
                              <!--Mobile Navigation Toggler-->
                              <div class="mobile-nav-toggler">
                                  <i class="icon-bar"></i>
                                  <i class="icon-bar"></i>
                                  <i class="icon-bar"></i>
                              </div>
                              <nav class="main-menu navbar-expand-md navbar-light">
                                  <div class="collapse navbar-collapse show clearfix" id="navbarSupportedContent">
                                      <ul class="navigation clearfix">
                                          <li class="current">
                                            <a href="/">Home</a>
                                          </li>
                                          <li class="dropdown"><a href="/products">Shop<span>Hot</span></a>
                                              <ul>
                                              <li><a href="/products?category=bookmark">Bookmarks</a></li>
                                              <li><a href="/products?category=pop gripper">Pop Grippers</a></li>
                                              <li><a href="/products?category=tote bag">Tote Bags</a></li>
                                              <li><a href="/products?category=badge">Badges</a></li>
                                              <li><a href="/products?category=a5 dairy">Diaries</a></li>
                                              <li><a href="/products?category=mousepad">Mousepads</a></li>
                                            </ul>
                                          </li>
                                          <!-- <li><a href="/about">About</a></li>     -->
                                          <!-- <li><a href="/blogs">Blog</a></li>  -->
                                          <li><a href="/contact">Contact</a></li>               
                                      </ul>
                                  </div>
                              </nav>
                          </div>
                          <ul class="menu-right-content clearfix">
                              <li>
                                  <div class="search-btn">
                                      <button type="button" class="search-toggler"><i class="flaticon-search"></i></button>
                                  </div>
                              </li>
                              <li><a href="/wishlist"><i class="flaticon-like"></i></a></li>
                              <li class="dropdown"><a><i class="flaticon-user"></i></a>
                                <ul>
                                  <% if(userLoggedIn) { %>
                                  <li><a href="/profile">Profile</a></li>
                                  <li><a href="/profile">Your orders</a></li>
                                  <li><a href="/logout">Logout</a></li>
                                  <% } else { %> 
                                  <li><a href="/login">Log In</a></li>
                                  <li><a href="/register">Sign Up</a></li>
                                  <% } %>
                              </ul></li>
                          </ul>
                      </div>
                  </div>
              </div>

              <!--sticky Header-->
              <div class="sticky-header">
                  <div class="auto-container">
                      <div class="outer-box clearfix">
                          <div class="logo-box pull-left">
                              <figure class="logo"><a href="/"><img src="/assets/images/small-logo.png" alt=""></a></figure>
                          </div>
                          <div class="menu-area pull-right">
                              <nav class="main-menu clearfix">
                                  <!--Keep This Empty / Menu will come through Javascript-->
                              </nav>
                          </div>
                      </div>
                  </div>
              </div>
          </header>
          <!-- main-header end -->

          <!-- Mobile Menu  -->
          <div class="mobile-menu">
              <div class="menu-backdrop"></div>
              <div class="close-btn"><i class="fas fa-times"></i></div>
              <nav class="menu-box">
                  <div class="nav-logo"><a href="/"><img src="/assets/images/small-logo.png" alt="" title=""></a></div>
                  <div class="menu-outer"><!--Here Menu Will Come Automatically Via Javascript / Same Menu as in Header--></div>
                  <div class="contact-info">
                      <h4>Contact Info</h4>
                      <ul>
                          <!-- <li>Chicago 12, Melborne City, USA</li> -->
                          <li><a href="tel:+91-9773034478">+91 97730 34478</a></li>
                          <li><a href="mailto:meehh.com@gmail.com">meehh.com@gmail.com</a></li>
                      </ul>
                  </div>
                  <div class="social-links">
                      <ul class="clearfix">
                          <li><a href="/"><span class="fab fa-twitter"></span></a></li>
                          <li><a href="/"><span class="fab fa-facebook-square"></span></a></li>
                          <li><a href="/"><span class="fab fa-pinterest-p"></span></a></li>
                          <li><a href="/"><span class="fab fa-instagram"></span></a></li>
                          <li><a href="/"><span class="fab fa-youtube"></span></a></li>
                      </ul>
                  </div>
              </nav>
          </div><!-- End Mobile Menu -->

      <!-- cart section -->

      <!-- page-title -->
      <section class="page-title centred">
        <div
          class="pattern-layer"
          style="
            background-image: url(/assets/images/background/page-title.jpg);
          "
        ></div>
        <div class="auto-container">
          <div class="content-box">
            <h1>Checkout</h1>
            <ul class="bread-crumb clearfix">
              <li><i class="flaticon-home-1"></i><a href="/">Home</a></li>
              <li>Checkout</li>
            </ul>
          </div>
        </div>
      </section>
      <!-- page-title end -->

      <!-- Multistep form -->
      <div class="container-fluid row">
        <!-- <div class="row justify-content-center mt-0"> -->
          <div class="col-12 col-lg-6 text-center p-0 mt-3 mb-2">
            <div class="px-0 pt-4 pb-0 m-3">
              <div class="shipping-info">
                <form action="/profile/add-new-address" method="post" class="shipping-form d-none">
                  <h4 class="details-title ml-3">Personal Details</h4>
                  <div class="row">
                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>First Name*</label>
                      <div class="field-input">
                        <input type="text" required name="first_name" />
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>Last Name*</label>
                      <div class="field-input">
                        <input type="text" required name="last_name" />
                      </div>
                    </div>
                  </div>
                  <h4 class="details-title ml-3">Address Details</h4>
                  <div class="row">  
                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>House No.*</label>
                      <div class="field-input">
                        <input type="text" required name="house_no" />
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>Street*</label>
                      <div class="field-input">
                        <input type="text" required name="street" />
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>Landmark <span>(optional)</span></label>
                      <div class="field-input">
                        <input type="text" name="landmark" />
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>City*</label>
                      <div class="field-input">
                        <input type="text" required name="city" />
                      </div>
                    </div>
                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>State*</label>
                      <div class="field-input">
                        <input type="text" required name="state" />
                      </div>
                    </div>

                    <div class="col-lg-4 col-md-6 col-sm-12 form-group">
                      <label>Pin Code*</label>
                      <div class="field-input">
                        <input type="text" required name="pincode" />
                      </div>
                    </div>
                  </div>
                  <button type="cancel" value="Cancel" onclick="showAddressFields()" class="theme-btn-one ml-3">Cancel</button>
                  <button type="submit" value="Save" class="theme-btn-two ml-3">Save</button>
                </form>
                <div class="shipping-details-container">
                  <h4 class="sub-title">Shipping Details</h4>
                  <input type="text" class="hidden-address" name="address" hidden>
                  <% if(addresses.length > 0) { %>
                    <div class="card-columns my-5 addresses">
                      <% for(let i=0;i<addresses.length;i++) { %>
                        <div class="option-block card p-2 py-lg-3 px-lg-4">
                          <div class="custom-controls-stacked">
                          <label class="custom-control material-checkbox">
                            <input
                            type="checkbox"
                              class="material-control-input"
                              onchange="selectAddress('<%=i%>')"
                              />
                              <span class="material-control-indicator"></span>
                              <h5 class="description"><%= addresses[i].first_name %> <%= addresses[i].last_name %></h5>
                              <p>
                              <%= addresses[i].house_no %>, <%= addresses[i].street %>, <%= addresses[i].landmark %> <%= addresses[i].landmark && "," %> <%= addresses[i].city %> - <%= addresses[i].pincode %>
                              <br> 
                              <%= addresses[i].state %>
                            </p>
                          </label>
                        </div>
                      </div>
                    <% } %>
                  <% } %>
                  <div class="card add-new-address" onclick="showAddressFields()">
                    <div class="card-body">
                      <div class="flaticon-plus"></div>
                      <div class="card-title">Add new address</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
          <div class="col-12 col-lg-6 text-center p-0 mt-3 mb-2">
            <div class="px-0 pt-4 pb-0 mt-3 mb-3">
              <div class="order-summary border rounded p-3 mb-4 mx-3">
                <h3 class="pb-3 mb-2 border-bottom">Order Summary</h3>
                <div class="order-items">
                    <div class="item">
                      <div class="d-flex align-items-center">
                        <img
                        src="<%= product.inventory[0].thumbnail_images[0] || product.inventory[0].large_images[0] %>"
                        alt="Product Image"
                        />
                        <div class="text-left">
                          <div class="product-name text-dark"><%= product.product_name%></div>
                        </div>
                      </div>
                      <div class="quantity ">&times;<%=quantity%></div>
                      <div class="total_amt ">Rs. <%= quantity * product.price %></div>
                    </div>
                </div>
                <div class="order-total mt-3 text-right">
                  <div class="sub-total">Sub Total: <span>Rs. <%= quantity * product.price %></span></div>
                  <!-- <div class="coupon-discount text-primary">- Coupon Discount: <span></span></div>  -->
                  <div class="">+ Shipping: <span>Rs. 80</span></div>
                  <div class="grand-total text-dark">Grand Total: <span>Rs. <%= quantity * product.price + 80%></span></div>
                </div>
                <div class="shipping-summary">
                  <h5>Shipping Details</h5>
                  <div class="name"></div>
                  <div class="address"></div>
                </div>
                <button class="theme-btn-two my-4" id="checkout">Pay now</button>
              </div>
          </div>
        </div>
      </div>

      <!-- page-title end -->

      <!-- cart section end -->
      </div>

      <%- include('footer')%>
    </div>
    <!-- jequery plugins -->
    <script src="/assets/js/jquery.js"></script>
    <script src="/assets/js/popper.min.js"></script>
    <script src="/assets/js/bootstrap.min.js"></script>
    <script src="/assets/js/owl.js"></script>
    <script src="/assets/js/wow.js"></script>
    <script src="/assets/js/validation.js"></script>
    <script src="/assets/js/jquery.fancybox.js"></script>
    <script src="/assets/js/TweenMax.min.js"></script>
    <script src="/assets/js/appear.js"></script>
    <script src="/assets/js/scrollbar.js"></script>
    <script src="/assets/js/jquery.nice-select.min.js"></script>
    <script src="/assets/js/isotope.js"></script>
    <script src="/assets/js/jquery-ui.js"></script>
    <script src="/assets/js/jquery.bootstrap-touchspin.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css"></script>

    <!-- main-js -->
    <script src="/assets/js/script.js"></script>
    
    <script>
      var addresses = <%- JSON.stringify(addresses) %>
      
      // dom elements
      const orderSummarySubtotal = document.querySelector(
        ".order-summary .order-total .sub-total span"
      );
      const orderSummaryCouponDiscount = document.querySelector(
        ".order-summary .order-total .coupon-discount span"
      );
      const orderSummaryGrandtotal = document.querySelector(
        ".order-summary .order-total .grand-total span"
      );
      const shippingNameDiv = document.querySelector(".shipping-summary .name");
      const shippingAddressDiv = document.querySelector(".shipping-summary .address");
      
      const addressCheckboxes = [
        ...document.querySelectorAll("input[type='checkbox'].material-control-input"),
      ];
      const checkoutBtn = document.querySelector("button#checkout");
      
      // Handle shipping address selection
      let selectedAddress;

      if (selectedAddress === undefined) checkoutBtn.disabled = true;

      function selectAddress(index) {
        console.log(index)
        if (addressCheckboxes[index].checked === true) {
          selectedAddress = addresses[index];

          document.querySelector("input.hidden-address").value =
            JSON.stringify(selectedAddress);

          addressCheckboxes.map((checkbox, i) => {
            if (i+"" !== index) {
              checkbox.disabled = true;
            }
          });
          checkoutBtn.disabled = false;

          shippingNameDiv.textContent = `${selectedAddress?.first_name} ${selectedAddress?.last_name}`
          shippingAddressDiv.textContent = `${selectedAddress?.house_no}, ${selectedAddress?.street}, ${selectedAddress?.landmark}, ${selectedAddress?.city}, ${selectedAddress?.state} - ${selectedAddress?.pincode}`
        } else {
          selectedAddress = {};
          checkoutBtn.disabled = true;
          addressCheckboxes.map((checkbox) => (checkbox.disabled = false));
          shippingNameDiv.textContent = ``
          shippingAddressDiv.textContent = ``
        }
      }

      // Show address input fields when clicked on add new address
      function showAddressFields() {
        const form = document.querySelector("form.shipping-form");
        form.classList.toggle("d-none");
        if (!form.classList.contains("d-none")) {
          checkoutBtn.disabled = true;
        }
        document
          .querySelector("div.shipping-details-container")
          .classList.toggle("d-none");
      }

      // initialized from the create-order response
      let order;
      let key;
      let userDetails;

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }

      document.getElementById("checkout").addEventListener("click", () => createOrder())

      // save order in database and create razorpay order
      async function createOrder() {
        console.log("in create order");
        const productCookie = getCookie("product")
        console.log(productCookie)
        console.log(selectedAddress)
        const res = await fetch("/checkout/create-order", {
          method: "POST",
          body: JSON.stringify({ product: productCookie, address: JSON.stringify(selectedAddress), instantBuy: true }),
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include"
        });
        const data = await res.json();
        console.log(data)
        if (res.ok) {
          order = data.result;
          key = data.key;
          userDetails = data.userDetails;
          orderSummarySubtotal.textContent = "Rs. " + order.notes.sub_total;
          // orderSummaryCouponDiscount.textContent =
          //   "Rs. " + order.notes.coupon_discount;
          orderSummaryGrandtotal.textContent = "Rs. " + order.amount / 100;
          console.log(order.notes)
          shippingNameDiv.textContent = order.notes.shipping_name;
          shippingAddressDiv.textContent = order.notes.shipping_address;
          intializeRazorpay();
        }
      }

      var razorpayObject;

      function intializeRazorpay() {
        const amount = order.amount;
        const currency = order.currency;
        const order_id = order.id;

        var options = {
          key: key,
          amount: amount,
          currency: currency,
          name: "Meehh.com",
          image: "http://localhost:5000/public/assets/images/logo.png",
          order_id: order_id,
          handler: async function (response) {
            const data = {
              order_id: response.razorpay_order_id,
              payment_id: response.razorpay_payment_id,
            };
            const res = await fetch("/checkout/verify-order", {
              method: "POST",
              body: JSON.stringify(data),
              headers: {
                "Content-Type": "application/json",
                "x-razorpay-signature": response.razorpay_signature,
              },
            });
            // console.log(await res.json());
          },
          prefill: {
            contact: userDetails?.phone_no,
            name: userDetails?.name,
            email: userDetails?.email,
          },
          notes: {
            shipping_address: userDetails.shipping_address,
          },
          modal: {
            confirm_close: true,
          },
          remember_customer: true,
          send_sms_hash: true,
        };
        razorpayObject = new Razorpay(options);

        razorpayObject.on("payment.failed", function (response) {
          alert("Sorry, we couln't process your payment successfully!");
        });

        razorpayObject.open()
      }

      function openRazorpayModal () {
        
      };

    </script>
  </body>
</html>
